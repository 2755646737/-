<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>足球数据管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script src="soccerData.js"></script>
    <script src="idb.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <meta name="apple-mobile-web-app-status-bar-style" content="#4299e1">
  <meta name="apple-mobile-web-app-title" content="赛事查询">

    <style>
        body { background-color: #f8f9fa; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .page-container { max-width: 850px; margin: 0 auto; padding: 15px; background: white; min-height: 100vh; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
        .nav-tabs .nav-link { color: #495057; cursor: pointer; font-weight: 600; border-radius: 8px 8px 0 0; padding: 10px 15px; }
        .nav-tabs .nav-link.active { background-color: #0d6efd; color: white; border-color: #0d6efd; }
        .form-label { font-weight: bold; font-size: 0.9rem; margin-bottom: 0.3rem; color: #333; }
        .form-control, .form-select { border-radius: 6px; }
        .autocomplete-list {
            position: absolute; width: 100%; z-index: 1050; max-height: 200px; overflow-y: auto;
            border: 1px solid #ccc; border-radius: 0 0 6px 6px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); background: white;
        }
        .autocomplete-item { cursor: pointer; padding: 0.5rem 1rem; border-bottom: 1px solid #eee; }
        .autocomplete-item:hover { background-color: #f8f9fa; }
        .btn-custom { margin-bottom: 10px; width: 100%; font-weight: 500; border-radius: 6px; }
        .table-responsive { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow-y: auto; max-height: 60vh; }
        .table thead th { background-color: #343a40; color: white; position: sticky; top: 0; z-index: 10; }
        .table td, .table th { vertical-align: middle; white-space: nowrap; font-size: 0.85rem; padding: 0.75rem 0.5rem; }
        .search-bar { margin-bottom: 15px; padding: 10px 0; border-bottom: 1px solid #eee; background: white; position: sticky; top: 0; z-index: 10; }
        .delete-btn { color: #dc3545; cursor: pointer; font-weight: bold; text-decoration: underline; font-size: 1rem; }
    </style>
</head>
<body>

<div id="app" class="page-container">
    <ul class="nav nav-tabs nav-fill mb-4">
        <li class="nav-item"><a class="nav-link" :class="{ active: currentPage === 1 }" @click="currentPage = 1"><i class="bi bi-pencil-square me-1"></i> 数据录入</a></li>
        <li class="nav-item"><a class="nav-link" :class="{ active: currentPage === 2 }" @click="currentPage = 2"><i class="bi bi-table me-1"></i> 本地数据 ({{ filteredData.length }})</a></li>
    </ul>

    <div v-show="currentPage === 1">
        <div class="row g-3">
            <div class="col-12">
                <label class="form-label">比赛日期 <span class="text-danger">*</span></label>
                <input type="date" class="form-control" v-model="form.date" required>
            </div>

            <div class="col-12 position-relative">
                <label class="form-label">联赛/赛事 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" v-model="form.league" @focus="showLeagueResults = true" @blur="hideResultsSafely('league')" placeholder="输入首字母(如 yc) 或 汉字" required>
                <ul v-if="showLeagueResults && filteredLeagues.length > 0 && form.league.length > 0" class="list-group autocomplete-list">
                    <li v-for="league in filteredLeagues" :key="league" class="list-group-item list-group-item-action" @mousedown.prevent="selectItem('league', league)">{{ league }}</li>
                </ul>
            </div>

            <div class="col-6 position-relative">
                <label class="form-label text-primary">主队 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" v-model="form.homeTeam" @focus="showHomeTeamResults = true" @blur="hideResultsSafely('home')" placeholder="输入首字母/汉字" required>
                <ul v-if="showHomeTeamResults && filteredHomeTeams.length > 0 && form.homeTeam.length > 0" class="list-group autocomplete-list">
                    <li v-for="team in filteredHomeTeams" :key="team" class="list-group-item list-group-item-action" @mousedown.prevent="selectItem('home', team)">{{ team }}</li>
                </ul>
            </div>

            <div class="col-6 position-relative">
                <label class="form-label text-danger">客队 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" v-model="form.awayTeam" @focus="showAwayTeamResults = true" @blur="hideResultsSafely('away')" placeholder="输入首字母/汉字" required>
                <ul v-if="showAwayTeamResults && filteredAwayTeams.length > 0 && form.awayTeam.length > 0" class="list-group autocomplete-list">
                    <li v-for="team in filteredAwayTeams" :key="team" class="list-group-item list-group-item-action" @mousedown.prevent="selectItem('away', team)">{{ team }}</li>
                </ul>
            </div>

            <div class="col-6">
                <label class="form-label">半场比分 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" v-model="form.halfScore" @blur="formatScore('halfScore')" placeholder="如: 10" required>
            </div>

            <div class="col-6">
                <label class="form-label">全场比分 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" v-model="form.fullScore" @blur="formatScore('fullScore')" placeholder="如: 21" required>
            </div>

            <div class="col-4">
                <label class="form-label">让球 <span class="text-danger">*</span></label>
                <select class="form-select" v-model="form.handicap" required>
                    <option value="+1">+1</option>
                    <option value="-1">-1</option>
                </select>
            </div>

            <div class="col-4">
                <label class="form-label">上盘赔率 <span class="text-danger">*</span></label> 
                <input type="text" class="form-control" v-model="form.upperOdds" @input="handleNumberInput($event, 'upperOdds', true)" @blur="formatOdds('upperOdds')"  placeholder="如: 111 自动变 1.11" required>
            </div>

            <div class="col-4">
                <label class="form-label">赔率变化 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" v-model="form.oddsChange" @input="handleNumberInput($event, 'oddsChange', false)" placeholder="如: 1120" required>
            </div>
        </div>

        <hr class="my-4">
        <div class="row">
            <div class="col-6"><button class="btn btn-primary btn-custom" @click="addData"><i class="bi bi-plus-lg me-1"></i> 添加</button></div>
            <div class="col-6"><button class="btn btn-secondary btn-custom" @click="clearLocalData"><i class="bi bi-trash3 me-1"></i> 清空</button></div>
            <div class="col-6"><button class="btn btn-success btn-custom" @click="exportCSV"><i class="bi bi-file-earmark-spreadsheet me-1"></i> 导出 CSV</button></div>
            <div class="col-6"><button class="btn btn-info text-white btn-custom" @click="uploadToCloud"><i class="bi bi-cloud-upload me-1"></i> 上传云端</button></div>
            <div class="col-12"><button class="btn btn-warning text-dark btn-custom" @click="downloadFromCloud"><i class="bi bi-cloud-download me-1"></i> 云端下发</button></div>
        </div>
    </div>

    <div v-show="currentPage === 2">
        <div class="search-bar">
            <div class="input-group">
                <span class="input-group-text bg-white"><i class="bi bi-search text-primary"></i></span>
                <input type="text" class="form-control" v-model="searchQuery" placeholder="搜索赔率 或 变化序列...">
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-dark">
                    <tr>
                        <th>日期</th><th>赛事</th><th>主队</th><th>客队</th><th>半场</th><th>全场</th><th>让球</th><th>赔率</th><th>变化</th><th class="text-center">操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-if="filteredData.length === 0"><td colspan="10" class="text-center py-5 text-muted">暂无数据</td></tr>
                    <tr v-for="(item, index) in filteredData" :key="index">
                        <td>{{ item.date.slice(5) }}</td>
                        <td>{{ item.league }}</td>
                        <td>{{ item.homeTeam }}</td>
                        <td>{{ item.awayTeam }}</td>
                        <td>{{ item.halfScore }}</td>
                        <td>{{ item.fullScore }}</td>
                        <td>{{ item.handicap }}</td>
                        <td><strong>{{ item.upperOdds }}</strong></td>
                        <td>{{ item.oddsChange }}</td>
                        <td class="text-center"><span class="delete-btn" @click="deleteItem(item)"><i class="bi bi-x-circle-fill"></i> 删除</span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, reactive, onMounted, watch, nextTick } = Vue;
    
    // --- 1. 获取外部数据 (从 window 对象读取) ---
    // 如果您没有创建 soccerData.js 文件，这里会是 undefined，导致搜索失效。
    const leagueData = window.leagueData || {}; 

    // --- 2. 拼音映射表 ---
    const PINYIN_MAP = {
        'a': '啊阿爱澳安埃阿尔阿布哈', 'b': '巴拜布博本贝毕比北伯', 'c': '中出川城场超昌柴查采蔡曹沧', 'd': '德大多东丹第蒂迪达杜敦',
        'e': '俄尔厄恩埃尔切', 'f': '法弗费芬富佛福弗赖弗罗', 'g': '国广哥格冈吉加加济竞高古瓜', 'h': '荷赫汉海韩湖哈黄黑合和河',
        'j': '甲级吉加济竞金京津吉贾姆', 'k': '克科卡凯喀肯昆库奎', 'l': '利勒拉里联鲁卢莱伦雷', 'm': '曼马摩米美蒙穆慕麦',
        'n': '那南纽诺尼内纳纽宁', 'o': '欧奥俄奥斯', 'p': '葡浦帕佩波普平潘庞', 'q': '球区切千青庆', 'r': '热仁日蓉让罗',
        's': '斯塞圣萨沙上深申索苏松', 't': '特托图坦泰提塔图特', 'w': '乌瓦维温武威沃韦瓦', 'x': '西新香锡夏希休谢',
        'y': '英意尤约亚雅伊叶延银', 'z': '中足泽州芝泽浙直张周朱詹',
        't': '泰天特托图坦泰', 's': '申上斯塞圣萨沙深', 'j': '津京吉加济竞', 'z': '浙直中足泽州芝', 'r': '蓉仁日', 
        'h': '河海韩湖赫荷', 'x': '西新香锡夏', 'a': '埃尔瓦', 'l': '莱加内斯', 'w': '温特图尔', 'p': '佩雷拉' 
    };

    // 工具：获取拼音首字母
    const getInitial = (text) => {
        if (!text) return '';
        let initials = '';
        for (let i = 0; i < text.length; i++) {
            const char = text[i];
            let found = false;
            for (const initial in PINYIN_MAP) {
                if (PINYIN_MAP[initial].includes(char)) {
                    initials += initial;
                    found = true;
                    break;
                }
            }
            if (!found) initials += char.toLowerCase();
        }
        return initials;
    };

    // --- 3. Firebase 配置 ---
    const cloudConfig = {
        apiKey: "AIzaSyD2gY00krxzujQ6ol4lbShxOflMw48vDdc",
        authDomain: "zuqiushuju.firebaseapp.com",
        databaseURL: "https://zuqiushuju-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "zuqiushuju",
        storageBucket: "zuqiushuju.firebasestorage.app",
        messagingSenderId: "1033657621876",
        appId: "1:1033657621876:web:6eed7f50786f1cd703a021",
        measurementId: "G-JWF2CEWXL1"
    };
    let dbRef = null;
    try {
        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(cloudConfig);
            dbRef = firebase.database().ref('matchDataFinal');
        }
    } catch (err) { console.error("Firebase Error:", err); }

    // --- 4. Vue 应用 ---
    createApp({
        setup() {
            const currentPage = ref(1);
            const localData = ref([]);
            const searchQuery = ref("");
            const showLeagueResults = ref(false);
            const showHomeTeamResults = ref(false);
            const showAwayTeamResults = ref(false);
            const currentTeams = ref([]);
            let leagueWatchTimeout = null;

            const form = reactive({
                date: new Date().toISOString().split('T')[0],
                league: "", homeTeam: "", awayTeam: "",
                halfScore: "", fullScore: "",
                handicap: "-1", upperOdds: "", oddsChange: ""
            });

            // 搜索逻辑
            const filterCommon = (list, queryStr) => {
                const query = queryStr.trim().toLowerCase();
                if (!query) return list;
                return list.filter(item => {
                    return item.toLowerCase().includes(query) || getInitial(item).includes(query);
                }).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));
            };

            const filteredLeagues = computed(() => filterCommon(Object.keys(leagueData), form.league));
            const filteredHomeTeams = computed(() => filterCommon(currentTeams.value, form.homeTeam));
            const filteredAwayTeams = computed(() => filterCommon(currentTeams.value, form.awayTeam));

            const isKnownLeague = computed(() => {
                return Object.keys(leagueData).some(k => k === form.league || k.toLowerCase() === form.league.toLowerCase());
            });

            // 联动：选联赛加载球队
            watch(() => form.league, (newVal) => {
                clearTimeout(leagueWatchTimeout);
                leagueWatchTimeout = setTimeout(() => {
                    const matchedKey = Object.keys(leagueData).find(k => k === newVal || k.toLowerCase() === newVal.toLowerCase());
                    if (matchedKey) currentTeams.value = leagueData[matchedKey];
                    else currentTeams.value = [];
                }, 200);
            });

            // UI交互
            const selectItem = (type, value) => {
                if (type === 'league') {
                    form.league = value;
                    form.homeTeam = ""; form.awayTeam = "";
                    showLeagueResults.value = false;
                } else if (type === 'home') {
                    form.homeTeam = value;
                    showHomeTeamResults.value = false;
                } else if (type === 'away') {
                    form.awayTeam = value;
                    showAwayTeamResults.value = false;
                }
            };

            const hideResultsSafely = (type) => {
                setTimeout(() => {
                    if (type === 'league') showLeagueResults.value = false;
                    if (type === 'home') showHomeTeamResults.value = false;
                    if (type === 'away') showAwayTeamResults.value = false;
                }, 200);
            };

            // 输入处理：比分 00 -> 0-0
            const formatScore = (field) => {
                let val = form[field].trim();
                if (/^\d{2}$/.test(val)) {
                    form[field] = `${val[0]}-${val[1]}`;
                } else if (val.includes(':') || val.includes('：')) {
                    form[field] = val.replace(/[:：]/g, '-');
                }
            };

            // 输入处理：赔率 111 -> 1.11
const formatOdds = (field) => {
    let val = form[field].trim();
    // 仅当输入为三位数字时，进行格式化
    if (/^\d{3}$/.test(val)) {
        form[field] = `${val[0]}.${val.slice(1, 3)}`;
    }
};

            // 输入处理：数字限制
            const handleNumberInput = (event, field, isDecimal) => {
                let val = event.target.value;
                val = val.replace(/[^\d.]/g, ''); // 去除非数字非点
                if (isDecimal) {
                    const parts = val.split('.');
                    if (parts.length > 2) val = parts[0] + '.' + parts.slice(1).join('');
                    if (parts.length === 2 && parts[1].length > 2) val = parts[0] + '.' + parts[1].slice(0, 2);
                } else {
                    val = val.replace(/\./g, ''); // 变化不允许小数点
                }
                form[field] = val;
                event.target.value = val;
            };

            // 数据操作
            const getUniqueKey = (item) => `${item.league}_${item.homeTeam}_${item.awayTeam}_${item.date}`;
            const isDuplicate = (newItem) => localData.value.some(item => getUniqueKey(item) === getUniqueKey(newItem));

            const addData = () => {
                const required = [form.date, form.league, form.homeTeam, form.awayTeam, form.halfScore, form.fullScore, form.handicap, form.upperOdds, form.oddsChange];
                if (required.some(f => !f || f.trim() === '')) return alert("请填写所有带 * 的必填项！");
                if (form.homeTeam === form.awayTeam) return alert("主客队不能相同");
                
                const newItem = { ...form };
                if (isDuplicate(newItem)) return alert("数据已存在！");

                localData.value.unshift(newItem);
                saveToLocal();
                
                // 重置逻辑：保留日期，重置让球为-1，其他清空
                const savedDate = form.date;
                Object.keys(form).forEach(k => form[k] = "");
                form.date = savedDate;
                form.handicap = "-1";
            };

            const deleteItem = (item) => {
                if(confirm("确定删除？")) {
                    localData.value = localData.value.filter(i => getUniqueKey(i) !== getUniqueKey(item));
                    saveToLocal();
                }
            };

            const clearLocalData = () => {
                if(confirm("清空本地？")) { localData.value = []; saveToLocal(); }
            };

            const saveToLocal = () => localStorage.setItem('football_data_pro', JSON.stringify(localData.value));
            const loadFromLocal = () => {
                const saved = localStorage.getItem('football_data_pro');
                if (saved) localData.value = JSON.parse(saved);
            };

            const exportCSV = () => {
                if (localData.value.length === 0) return alert("无数据");
                let csv = "data:text/csv;charset=utf-8,\uFEFF日期,赛事,主队,客队,半场,全场,让球,赔率,变化\n";
                const esc = (v) => `"${String(v).replace(/"/g, '""')}"`;
                localData.value.forEach(row => {
                    // 比分前加单引号，强制文本格式
                    csv += [esc(row.date), esc(row.league), esc(row.homeTeam), esc(row.awayTeam), esc(` ${row.halfScore}`), esc(` ${row.fullScore}`), esc(row.handicap), esc(row.upperOdds), esc(row.oddsChange)].join(',') + "\n";
                });
                const link = document.createElement("a");
                link.href = encodeURI(csv);
                link.download = `Data_${new Date().getTime()}.csv`;
                link.click();
            };

            // 云端逻辑 (简化)
            const uploadToCloud = () => {
                if(!dbRef || !navigator.onLine) return alert("无法连接云端");
                dbRef.once('value', snap => {
                    const cData = snap.val() || {};
                    const keys = new Set(Object.values(cData).map(getUniqueKey));
                    const batch = {};
                    let count = 0;
                    localData.value.forEach(item => {
                        if(!keys.has(getUniqueKey(item))) {
                            batch[dbRef.push().key] = item;
                            count++;
                        }
                    });
                    if(count > 0) dbRef.update(batch).then(() => alert(`上传 ${count} 条`));
                    else alert("无新数据");
                });
            };

            const downloadFromCloud = () => {
                if(!dbRef || !navigator.onLine) return alert("无法连接云端");
                if(!confirm("确定下载？")) return;
                dbRef.once('value', snap => {
                    const list = Object.values(snap.val() || {});
                    const keys = new Set(localData.value.map(getUniqueKey));
                    let count = 0;
                    list.forEach(item => {
                        if(!keys.has(getUniqueKey(item))) { localData.value.unshift(item); count++; }
                    });
                    saveToLocal();
                    alert(`下载 ${count} 条`);
                });
            };

           // --- 替换位置：原 onMounted(loadFromLocal); 这一行 ---
onMounted(() => {
    // 1. 正常加载本地数据
    loadFromLocal();
    nextTick(() => {
        // 如果问题依然存在，可以在这里尝试再次触发一个小的响应式更新，
        // 但通常 nextTick 自身就足够了。
    });
});

            const filteredData = computed(() => {
                const q = searchQuery.value.trim();
                if (!q) return localData.value;
                return localData.value.filter(i => i.upperOdds === q || (q.length >=3 && i.oddsChange.includes(q)));
            });

            return {
                currentPage, form, localData, searchQuery, filteredData,formatOdds,
                // 搜索
                showLeagueResults, showHomeTeamResults, showAwayTeamResults,
                filteredLeagues, filteredHomeTeams, filteredAwayTeams, isKnownLeague,
                selectItem, hideResultsSafely,
                // 操作
                addData, deleteItem, clearLocalData, exportCSV, uploadToCloud, downloadFromCloud,
                formatScore, handleNumberInput
            };
        }
    }).mount('#app');
</script>
</body>

</html>
